#!/usr/bin/env ruby

require 'daemons'
require 'logger'

$lid = "/proc/acpi/button/lid/LID0/state"

Daemonize.daemonize()

if Dir.exists?(File.dirname(File.expand_path('~/tmp/'))) then 
  log = Logger.new(File.expand_path('~/tmp/lidwatch.log'))
else
  log = Logger.new('/tmp/lidwatch.log')
end

log.level = Logger::INFO
log.info "#{Time.now} lidwatch starting for #{$lid}"

while true
  sleep 5
  f = File.new($lid)
  state = f.read
  f.close
  if state =~ /state:\s+closed/ then
    log.info "#{Time.now} new state is close; going suspend mode"
    `dbus-send --system --print-reply --dest="org.freedesktop.UPower" /org/freedesktop/UPower org.freedesktop.UPower.Suspend`
    sleep 20
  else
    log.info "#{Time.now} new state is open; ignoring"
  end
end


